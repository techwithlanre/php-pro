name: Publish VS Code Extension

on:
  workflow_dispatch:
    inputs:
      publish:
        description: Publish to VS Code Marketplace
        required: true
        default: false
        type: boolean
  push:
    tags:
      - "v2.0.3"  # Update this tag pattern as needed

permissions:
  contents: read

concurrency:
  group: vscode-marketplace-publish
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || inputs.publish == true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - run: npm run compile

      - name: Verify tag matches package.json version
        if: startsWith(github.ref, 'refs/tags/v')
        run: node -e "const pkg=require('./package.json'); const tag=process.env.GITHUB_REF_NAME; const expected='v'+pkg.version; if(tag!==expected){ console.error(`Tag ${tag} does not match package.json version ${expected}`); process.exit(1);} console.log('ok')"

      - name: Package VSIX
        run: npx @vscode/vsce package --out extension.vsix

      - uses: actions/upload-artifact@v4
        with:
          name: extension-vsix
          path: extension.vsix

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx @vscode/vsce publish --packagePath extension.vsix -p "$VSCE_PAT"

